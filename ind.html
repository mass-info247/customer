<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MASS Customer Inquiry System (‡¶∂‡ßÅ‡¶ß‡ßÅ‡¶Æ‡¶æ‡¶§‡ßç‡¶∞ ‡¶¨‡¶ï‡ßá‡ßü‡¶æ ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü)</title>
    
    <style>
        /* Base Styles */
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 5px;
            background-color: #e9ecef; /* Light gray background */
            color: #333;
        }

        /* Header Styling */
        .main-header {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1px 0;
            background-color: #fff;
            border-bottom: 2px solid #ddd;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
         
        .header-logo {
            max-width: 100px;
            height: auto;
            margin-right: 15px;
        }

        .header-text h3 {
            margin: 0;
            color: #244850;
            font-size: 22px;
        }

        .header-text h4 {
            margin: 5px 0 0 0;
            color: #555;
            font-size: 14px;
        }

        /* Search Form Styling */
        #searchContainer {
            background-color: #ffffff;
            padding: 2px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            margin-bottom: 30px;
            text-align: center;
        }
        
        #customerPhoneSearch {
            padding: 10px;
            width: 80%;
            max-width: 300px;
            margin-right: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 16px;
        }
        
        #searchButton {
            padding: 10px 20px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }
        
        #searchButton:hover {
            background-color: #0056b3;
        }

        /* Report Section Styling */
        #customerReportSection {
            background-color: #ffffff;
            padding: 4px;
            border-radius: 8px;
            box-shadow: 14px 14px 20px #cbced1, -14px -14px 20px white;  }
        
        .hidden {
            display: none !important;
        }
        
        h2 {
            color: #244850;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
            margin-bottom: 20px;
            text-align: center;
        }

        /* Customer Summary */
        .purchase-summary {
            margin-top: 20px;
            padding: 15px;
            border: 1px solid #007bff;
            background-color: #e6f7ff;
            border-radius: 4px;
            font-size: 16px;
            font-weight: bold;
        }
        
        .due-amount-highlight {
            color: red;
            font-weight: bold;
        }

        /* Individual Purchase/Invoice Styling */
        .purchase-div {
            border: 1px solid #ccc;
            padding: 10px;
            margin-bottom: 35px;
            border-radius: 5px;
            background-color: #fefefe;
           box-shadow: 14px 14px 20px #cbced1, -14px -14px 20px white;
        }
        
        .purchase-div h4 {
            color: seagreen;
            margin-top: 0;
            border-bottom: 1px dashed #ddd;
            padding-bottom: 5px;
            
        }
        
        .purchase-div p strong {
            display: inline-block;
            width: 150px;
        }

        /* Table Styling (Invoice Items & Payment Log) - ‡¶∏‡ßç‡¶ü‡¶æ‡¶á‡¶≤ ‡¶ú‡ßã‡¶∞‡¶¶‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá */
        #customerReportSection table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        
        #customerReportSection table th, 
        #customerReportSection table td {
            /* ‡¶ü‡ßá‡¶¨‡¶ø‡¶≤ ‡¶°‡ßá‡¶ü‡¶æ/‡¶π‡ßá‡¶°‡¶æ‡¶∞ ‡¶∏‡ßç‡¶ü‡¶æ‡¶á‡¶≤ */
            border: 1px solid #eee;
            padding: 8px;
            text-align: center;
            font-size: 13px;
        }
        
        #customerReportSection table th {
            background-color: #f1f1f1;
            font-weight: bold;
        }
        
       
    </style>
</head>
<body>
    
    <header>
        <div class="main-header">
            <img src="img.png" alt="Modern Apparel Style Solutian Logo" class="header-logo">
            <div class="header-text">
                <h3>Modern Apparel Style Solution (MASS)</h3>
                <h4>Customer Inquiry System</h4>
            </div>
        </div>
    </header>

    <main>
        <section id="searchContainer">
            <h2>üîç ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï‡ßá‡¶∞ ‡¶§‡¶•‡ßç‡¶Ø ‡¶Ö‡¶®‡ßÅ‡¶∏‡¶®‡ßç‡¶ß‡¶æ‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</h2>
            <input type="number" id="customerPhoneSearch" placeholder="‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï‡ßá‡¶∞ ‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤ ‡¶®‡¶æ‡¶Æ‡ßç‡¶¨‡¶æ‡¶∞ (e.g., 017XXXXXXXX)" maxlength="15">
            <button id="searchButton">‡¶Ö‡¶®‡ßÅ‡¶∏‡¶®‡ßç‡¶ß‡¶æ‡¶®</button>
        </section>

        <section id="customerReportSection" class="hidden">
            <h2>üìú ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï‡ßá‡¶∞ ‡¶≤‡ßá‡¶®‡¶¶‡ßá‡¶®‡ßá‡¶∞ ‡¶á‡¶§‡¶ø‡¶π‡¶æ‡¶∏</h2>
            
            <div id="customerInfo">
                <h3><strong>‡¶®‡¶æ‡¶Æ:</strong> <span id="customerReportName"></span></h3>
                <p><strong>‡¶´‡ßã‡¶®:</strong> <span id="customerReportPhone"></span></p>
                <p><strong>‡¶†‡¶ø‡¶ï‡¶æ‡¶®‡¶æ:</strong> <span id="customerReportAddress"></span></p>
            </div>
            
            <div class="purchase-summary">
                <strong>‡¶Æ‡ßã‡¶ü ‡¶¨‡¶ï‡ßá‡¶Ø‡¶º‡¶æ (Outstanding Due):</strong> <span id="customerTotalDue" class="due-amount-highlight">0.00 TK</span>
            </div>
            
            <h3 style="margin-top: 30px; color: #007bff;">‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶≤‡¶ó (‡¶¨‡¶ï‡ßá‡¶Ø‡¶º‡¶æ ‡¶™‡¶∞‡¶ø‡¶∂‡ßã‡¶ß)</h3>
            <table id="customerPaymentsLogTable">
                <thead>
                    <tr>
                        <th>‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ ‡¶ì ‡¶∏‡¶Æ‡ßü</th>
                        <th>‡¶™‡¶∞‡¶ø‡¶∂‡ßã‡¶ß‡¶ø‡¶§ ‡¶Ö‡¶∞‡ßç‡¶• (TK)</th>
                        <th>‡¶∞‡ßá‡¶´‡¶æ‡¶É ‡¶á‡¶®‡¶≠‡ßü‡ßá‡¶∏ ‡¶®‡¶Ç</th>
                        <th>‡¶™‡¶∞‡¶ø‡¶∂‡ßã‡¶ß‡¶ø‡¶§ ‡¶¨‡¶ï‡ßá‡ßü‡¶æ (TK)</th>
                    </tr>
                </thead>
                <tbody id="customerPaymentsLogBody">
                    <tr><td colspan="4" style="text-align: center;">‡¶ï‡ßã‡¶® ‡¶¨‡¶ï‡ßá‡¶Ø‡¶º‡¶æ ‡¶™‡¶∞‡¶ø‡¶∂‡ßã‡¶ß ‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶° ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡¶®‡¶ø‡•§</td></tr>
                </tbody>
            </table>
            <h3 style="margin-top: 30px; color: #007bff;">‡¶ï‡ßç‡¶∞‡¶Ø‡¶º‡ßá‡¶∞ ‡¶á‡¶§‡¶ø‡¶π‡¶æ‡¶∏ (‡¶á‡¶®‡¶≠‡¶Ø‡¶º‡ßá‡¶∏ ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ)</h3>
            <div id="customerPurchaseHistory">
                <p style="text-align: center;">‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï‡ßá‡¶∞ ‡¶ï‡ßã‡¶®‡ßã ‡¶ï‡ßç‡¶∞‡¶Ø‡¶º ‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶° ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø‡•§</p>
            </div>
            
        </section>

        </main>

    <script type="module" defer>
        // Import Firebase functions
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
        import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-database.js";

        // Your web app's Firebase configuration 
        const firebaseConfig = {
            apiKey: "AIzaSyCA-7y10NVwFG5hCNaafSw6_w1D0IsXo7s",
            authDomain: "mass-244c7.firebaseapp.com",
            databaseURL: "https://mass-244c7-default-rtdb.firebaseio.com",
            projectId: "mass-244c7",
            storageBucket: "mass-244c7.firebasestorage.app",
            messagingSenderId: "73049426644",
            appId: "1:73049426644:web:db8b7c598f6192f4700941",
            measurementId: "G-0DR3XNB5VQ"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

        // Reference to Firebase path
        const customersRef = ref(database, 'customers');

        // --- Data Storage ---
        let customers = [];
        let currentCustomerPhone = null;

        // --- Utility Functions for Data Handling ---
        
        // Helper function to format currency
        function formatCurrency(amount) {
            return `${parseFloat(amount).toFixed(2)} TK`;
        }

        // Function to calculate a single customer's total outstanding due (‡¶∏‡¶Ç‡¶∂‡ßã‡¶ß‡¶ø‡¶§ ‡¶≤‡¶ú‡¶ø‡¶ï)
        function getCustomerTotalDue(customer) {
            let totalDueFromInvoices = 0;
            let totalPaymentsLogged = 0;

            // 1. Calculate the total due amount from all invoices (after initial purchase paidAmount)
            if (customer && customer.purchases && customer.purchases.length > 0) {
                customer.purchases.forEach(purchase => {
                    // Due = Total Payable - Paid Amount at the time of transaction
                    const purchaseTotalPayable = purchase.totalPayable || (purchase.totalAmount + (purchase.previousDue || 0));
                    const purchasePaidAmount = purchase.paidAmount || 0;
                    const finalOutstandingDueAfterTransaction = Math.max(0, purchaseTotalPayable - purchasePaidAmount);
                    
                    totalDueFromInvoices += finalOutstandingDueAfterTransaction; 
                });
            }
            
            // 2. Sum up all the amounts cleared via the Payments Log (Subsequent due payments)
            if (customer && customer.paymentsLog && customer.paymentsLog.length > 0) {
                customer.paymentsLog.forEach(log => {
                    // Summing up only the amount that cleared previous dues (clearedAmount)
                    totalPaymentsLogged += parseFloat(log.clearedAmount || 0); 
                });
            }
            
            // 3. Calculate the Final Grand Total Outstanding Due
            const finalOutstandingDue = Math.max(0, totalDueFromInvoices - totalPaymentsLogged);

            return parseFloat(finalOutstandingDue.toFixed(2));
        }

        // --- Firebase Data Listener (Primary Data Source) ---
        onValue(customersRef, (snapshot) => {
            if (snapshot.exists()) {
                customers = snapshot.val();
                console.log("Customers from Firebase:", customers);
                // If a customer search was active, re-render the report
                if (currentCustomerPhone) {
                    renderCustomerReport(currentCustomerPhone);
                }
            } else {
                customers = [];
                console.log("No customers in Firebase.");
            }
        });

        // --- Main Logic on DOM Load ---
        document.addEventListener('DOMContentLoaded', () => {
            // DOM Elements
            const customerReportSection = document.getElementById('customerReportSection');
            const searchButton = document.getElementById('searchButton');
            const customerPhoneSearchInput = document.getElementById('customerPhoneSearch');
            
            // Customer Report Elements
            const customerReportNameSpan = document.getElementById('customerReportName');
            const customerReportPhoneSpan = document.getElementById('customerReportPhone');
            const customerReportAddressSpan = document.getElementById('customerReportAddress');
            const customerPurchaseHistoryDiv = document.getElementById('customerPurchaseHistory');
            const customerTotalDueSpan = document.getElementById('customerTotalDue');
            const customerPaymentsLogBody = document.getElementById('customerPaymentsLogBody'); 
            

            // Helper function to hide the report section
            function hideReport() {
                customerReportSection.classList.add('hidden');
                customerPurchaseHistoryDiv.innerHTML = `<p style="text-align: center;">‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï‡ßá‡¶∞ ‡¶ï‡ßã‡¶®‡ßã ‡¶ï‡ßç‡¶∞‡¶Ø‡¶º ‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶° ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø‡•§</p>`;
            }


            // Function to render individual customer report
            function renderCustomerReport(customerPhone) {
                const customer = customers.find(c => c.phone === customerPhone); 
                currentCustomerPhone = customerPhone;

                if (!customer) {
                    alert(`‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤ ‡¶®‡¶æ‡¶Æ‡ßç‡¶¨‡¶æ‡¶∞ ${customerPhone} ‡¶è‡¶∞ ‡¶ï‡ßã‡¶®‡ßã ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø‡•§`);
                    hideReport();
                    return;
                }
                
                // Show the main report section
                customerReportSection.classList.remove('hidden');

                // Populate basic info
                customerReportNameSpan.textContent = customer.name || 'N/A';
                customerReportPhoneSpan.textContent = customer.phone;
                customerReportAddressSpan.textContent = customer.address || 'N/A';

                customerPurchaseHistoryDiv.innerHTML = '';
                let grandTotalDue = getCustomerTotalDue(customer); 

                // --- Render Payments Log ---
                customerPaymentsLogBody.innerHTML = '';
                if (customer.paymentsLog && customer.paymentsLog.length > 0) {
                    // Sort by date/time (newest first)
                    customer.paymentsLog.sort((a, b) => {
                        const dateA = new Date(a.dateTime.replace(/(\d{2})\/(\d{2})\/(\d{4}), (\d{2}):(\d{2})/, '$3-$2-$1T$4:$5:00'));
                        const dateB = new Date(b.dateTime.replace(/(\d{2})\/(\d{2})\/(\d{4}), (\d{2}):(\d{2})/, '$3-$2-$1T$4:$5:00'));
                        return dateB - dateA;
                    }).forEach(log => {
                        const row = customerPaymentsLogBody.insertRow();
                        row.insertCell(0).textContent = log.dateTime;
                        row.insertCell(1).textContent = formatCurrency(log.paymentAmount);
                        row.insertCell(2).textContent = log.refInvoice || 'N/A';
                        row.insertCell(3).textContent = formatCurrency(log.clearedAmount);
                    });
                } else {
                    customerPaymentsLogBody.innerHTML = '<tr><td colspan="4" style="text-align: center;">‡¶ï‡ßã‡¶® ‡¶¨‡¶ï‡ßá‡¶Ø‡¶º‡¶æ ‡¶™‡¶∞‡¶ø‡¶∂‡ßã‡¶ß ‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶° ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡¶®‡¶ø‡•§</td></tr>';
                }

                // --- Render Purchase History ---
                if (!customer.purchases || customer.purchases.length === 0) {
                    customerPurchaseHistoryDiv.innerHTML = '<p style="text-align: center;">‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï‡ßá‡¶∞ ‡¶ï‡ßã‡¶®‡ßã ‡¶ï‡ßç‡¶∞‡¶Ø‡¶º ‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶° ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø‡•§</p>';
                } else {
                    customer.purchases.sort((a,b) => {
                        // Sort by date: Newest first (Descending)
                        const [dA, mA, yA] = a.date.split('/').map(Number);
                        const [dB, mB, yB] = b.date.split('/').map(Number);
                        const dateA = new Date(yA, mA - 1, dA);
                        const dateB = new Date(yB, mB - 1, dB);
                        return dateB - dateA; 
                    }).forEach((purchase) => {
                        const purchaseDiv = document.createElement('div');
                        purchaseDiv.classList.add('purchase-div');

                        // Recalculate Final Outstanding Due: Total Payable - Paid Amount (only for this transaction)
                        const purchaseTotalPayable = purchase.totalPayable || (purchase.totalAmount + (purchase.previousDue || 0));
                        const purchasePaidAmount = purchase.paidAmount || 0;
                        const finalOutstandingDueAfterTransaction = Math.max(0, purchaseTotalPayable - purchasePaidAmount);

                        purchaseDiv.innerHTML = `
                            <h4>üìÑ ‡¶á‡¶®‡¶≠‡¶Ø‡¶º‡ßá‡¶∏ ‡¶®‡¶Ç: ${purchase.invoiceNo} (‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ: ${purchase.date})</h4>
                            <p>
                                <strong>‡¶Æ‡ßã‡¶ü ‡¶ó‡ßç‡¶∞‡¶∏ ‡¶¨‡¶ø‡¶≤:</strong> ${formatCurrency(purchase.subTotal || purchase.totalAmount)}<br>
                                <strong>‡¶°‡¶ø‡¶∏‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü:</strong> ${formatCurrency(purchase.discount || 0)}<br>
                                <strong>‡¶®‡ßá‡¶ü ‡¶¨‡¶ø‡¶≤:</strong> ${formatCurrency(purchase.totalAmount)}<br>
                                <hr style="border-top: 1px dashed #eee; margin: 5px 0;">
                                <strong>‡¶™‡ßÇ‡¶∞‡ßç‡¶¨‡ßá‡¶∞ ‡¶¨‡¶ï‡ßá‡¶Ø‡¶º‡¶æ:</strong> ${formatCurrency(purchase.previousDue || 0)}<br>
                                <strong>‡¶Æ‡ßã‡¶ü ‡¶™‡ßç‡¶∞‡¶¶‡ßá‡¶Ø‡¶º:</strong> ${formatCurrency(purchaseTotalPayable)}<br>
                                <strong>‡¶™‡¶∞‡¶ø‡¶∂‡ßã‡¶ß‡¶ø‡¶§ ‡¶Ö‡¶∞‡ßç‡¶•:</strong> ${formatCurrency(purchasePaidAmount)}<br>
                                <strong>‡¶ö‡ßÇ‡¶°‡¶º‡¶æ‡¶®‡ßç‡¶§ ‡¶¨‡¶ï‡ßá‡¶Ø‡¶º‡¶æ (‡¶è‡¶á ‡¶¨‡¶ø‡¶≤‡ßá‡¶∞ ‡¶™‡¶∞):</strong> <span class="${finalOutstandingDueAfterTransaction > 0 ? 'due-amount-highlight' : ''}">${formatCurrency(finalOutstandingDueAfterTransaction)}</span>
                            </p>
                            <table>
                                <thead>
                                    <tr>
                                        <th>‡¶™‡¶£‡ßç‡¶Ø‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ</th>
                                        <th>‡¶∏‡¶æ‡¶á‡¶ú</th>
                                        <th>‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£</th>
                                        <th>‡¶á‡¶â‡¶®‡¶ø‡¶ü ‡¶Æ‡ßÇ‡¶≤‡ßç‡¶Ø (TK)</th>
                                        <th>‡¶∏‡¶æ‡¶¨‡¶ü‡ßã‡¶ü‡¶æ‡¶≤ (TK)</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${purchase.items.map(item => `
                                        <tr>
                                            <td>${item.itemName}</td>
                                            <td>${item.itemSize}</td>
                                            <td>${item.quantity}</td>
                                            <td>${formatCurrency(item.unitPrice)}</td>
                                            <td>${formatCurrency(item.subtotal)}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                            `;
                        
                        customerPurchaseHistoryDiv.appendChild(purchaseDiv);
                    });
                }
                
                // Update Summary
                customerTotalDueSpan.textContent = formatCurrency(grandTotalDue);
            }


            // --- Event Listeners ---
            
            // 1. Search Button Click
            searchButton.addEventListener('click', () => {
                const phone = customerPhoneSearchInput.value.trim();
                if (phone) {
                    renderCustomerReport(phone);
                } else {
                    alert('‡¶Ö‡¶®‡ßÅ‡¶∏‡¶®‡ßç‡¶ß‡¶æ‡¶®‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤ ‡¶®‡¶æ‡¶Æ‡ßç‡¶¨‡¶æ‡¶∞ ‡¶™‡ßç‡¶∞‡¶¶‡¶æ‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®‡•§');
                    hideReport();
                }
            });
            
            // 2. Enter Key in Input Field
            customerPhoneSearchInput.addEventListener('keypress', (e) => {
                 if (e.key === 'Enter') {
                    searchButton.click();
                 }
            });


            hideReport();
        });
    </script>
</body>
</html>
